<!DOCTYPE html>
<html lang="zh-ch">
<head>
  
    <title>Nginx 静态编译 :: 火龙果的博客 — 分享学到的知识</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="在使用 docker多阶段部署 后，镜像大小得到了有效瘦身，部署速度大幅度提升。 最近需要在项目中放一个nginx来代理http请求到golang"/>
<meta name="keywords" content="nginx, 编译, 静态编译, nginx静态编译, 多阶段打包"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://yanlong.me/post/nginx-static-build/" />


<link rel="stylesheet" href="https://yanlong.me/assets/style.css">

  <link rel="stylesheet" href="https://yanlong.me/assets/blue.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://yanlong.me/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="https://yanlong.me/img/favicon/blue.png">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Nginx 静态编译 :: 火龙果的博客 — 分享学到的知识" />
<meta name="twitter:description" content="在使用 docker多阶段部署 后，镜像大小得到了有效瘦身，部署速度大幅度提升。 最近需要在项目中放一个nginx来代理http请求到golang" />
<meta name="twitter:site" content="https://yanlong.me/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="zh-ch" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Nginx 静态编译 :: 火龙果的博客 — 分享学到的知识">
<meta property="og:description" content="在使用 docker多阶段部署 后，镜像大小得到了有效瘦身，部署速度大幅度提升。 最近需要在项目中放一个nginx来代理http请求到golang" />
<meta property="og:url" content="https://yanlong.me/post/nginx-static-build/" />
<meta property="og:site_name" content="Nginx 静态编译" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-11-15 10:51:55 &#43;0800 CST" />









<link rel="stylesheet" href="/assets/github.min.css">
<script src="/assets/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script data-ad-client="ca-pub-4136853851848129" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124887845-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124887845-1');
</script>


</head>
<body class="">


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://yanlong.me/">
  <div class="logo">
    火龙果的博客
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://yanlong.me/post/nginx-static-build/">Nginx 静态编译</a></h1>
  <div class="post-meta">
      
    <span class="post-date">
      2019-11-15
    </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://yanlong.me/tags/nginx/">nginx</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    

<p>在使用 <a href="https://yanlong.me/post/docker-multi-stage-build/">docker多阶段部署</a> 后，镜像大小得到了有效瘦身，部署速度大幅度提升。</p>

<p>最近需要在项目中放一个nginx来代理http请求到golang，一般来说nginx编译都是动态编译模式，会依赖很多系统so。如果只是单纯的把nginx的binary复制到docker 第二阶段，会导致
在新的image中找不到依赖的so文件，从而nginx不能正常工作。</p>

<p>第一想到的就是可以静态编译nginx，让依赖的所有so都集成到binary里面，这样就可以复制整个nginx目录到新image。</p>

<h2 id="静态编译">静态编译</h2>

<p>由于线上环境是ubuntu 16.04，为了兼容性，我们找一台ubuntu 16.04机器进行打包。</p>

<h3 id="创建临时打包环境">创建临时打包环境</h3>

<pre><code class="language-shell">$ docker run -it ubuntu:16.04 bash
</code></pre>

<h3 id="编译nginx">编译nginx</h3>

<pre><code class="language-shell"># 下载openssl依赖
$ wget https://www.openssl.org/source/openssl-1.0.2g.tar.gz

# 下载nginx
$ wget http://nginx.org/download/nginx-1.16.1.tar.gz

# 解压openssl &amp; 解压nginx
$ tar zxvf openssl-1.0.2g.tar.gz
$ tar zxvf nginx-1.16.1.tar.gz

# configure nginx
# 这一步很关键，需要添加cc 和 ld 选项
# openssl 也必须用源码，要不然不会成功
$ cd nginx-1.16.1
$ ./configure --with-cc-opt='-static -static-libgcc' --with-ld-opt=-static --prefix=/usr/local/nginx --user=root --group=root --with-http_ssl_module --with-openssl=../openssl-1.0.2g

# 编译 安装
$ make &amp;&amp; make install

# 如果需要更快速度的编译，可以加上-j选项，启动多核心同时编译，比如40核处理器
# make -j40 &amp;&amp; make install

# 打包整个nginx包，上传到私有仓库，这里我用static.yanlong.me模拟私有仓库
$ cd /usr/local
$ tar zcvf nginx-static-1.16.1.tar.gz nginx

$ scp nginx-static-1.16.1.tar.gz root@static.yanlong.me:/var/static/libraries
</code></pre>

<h2 id="多阶段打包">多阶段打包</h2>

<p>上面步骤已经准备好了nginx的静态编译包，现在我们只需在多阶段部署时添加进去即可。</p>

<pre><code class="language-dockerfile"># 第一阶段
FROM ubuntu:16.04 as build-env

RUN apt-get update -y &amp;&amp; \
    apt-get install --no-install-recommends -y make curl tar unzip ca-certificates &amp;&amp; apt-get install gcc -y

# 下载已经编译好的二进制包，这样可以加快CI速度
RUN curl -o nginx-static-1.16.1.tar.gz https://static.yanlong.me/libraries/nginx-static-1.16.1.tar.gz &amp;&amp; tar zxf nginx-static-1.16.1.tar.gz &amp;&amp; mv nginx /usr/local/

# 第二阶段
FROM ubuntu:16.04
# 把第一阶段下载的nginx包复制到当前阶段
COPY --from=build-env /usr/local/nginx/ /usr/local/nginx/
</code></pre>

<h2 id="测试">测试</h2>

<pre><code class="language-shell">docker run -it ubuntu:nginx bash
# 在容器内shell运行
/usr/local/nginx/sbin/nginx -t

# 输出
# nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
# nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
</code></pre>

<p>经过这样改动，CI速度大幅度提升，docker image占用空间也得到了优化。</p>

  </div>
  <img src="/images/qrcode.png" width="300px" style="margin: 0 auto">
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h"></span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      
      <span class="button next">
        <a href="https://yanlong.me/post/github-actions/">
          <span class="button__text">Github Actions 简介</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  
  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>© 2019 Powered by <a href="https://yanlong.me">yanlong.me</a></span>
    
        <span>:: Theme made by panr</span>
      </div>
  </div>
  <div class="footer__inner">
      <div class="copyright copyright--user">
        <span class="theme-info">
          <a class="theme-link" href="https://yuerblog.cc/" target="_blank">鱼儿的博客</a>
          <span class="division">|</span>
          <a class="theme-link" href="http://www.is17.com/" target="_blank">依十七</a>
          <span class="division">|</span>
          <a class="theme-link" href="https://zzrdark.github.io/" target="_blank">zzrdark的技术专栏</a>
          <span class="division">|</span>
          <a class="theme-link" href="https://wujunze.com" target="_blank">吴钧泽博客</a>
        </span>
      </div>
  </div>
</footer>

<script src="https://yanlong.me/assets/main.js"></script>





  
</div>

</body>
</html>
